<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="Super simple calculator for visualizing and estimating the prospects for going off-grid." />
        <style>:root{--state__calculator--opacity: 0.5;--state__overlay--opacity: 1;--state__fetching--opacity: 1}.state__calculator{transition:opacity .5s ease;opacity:var(--state__calculator--opacity)}.state__overlay{transition:opacity .5s ease;opacity:var(--state__overlay--opacity)}.state__fetching{transition:opacity .5s ease;opacity:var(--state__fetching--opacity)}*,*::before,*::after{box-sizing:border-box}*{margin:0}body{background-color:#202124;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}img,canvas{display:block}input,button,textarea,select{font:inherit}a:link{color:#84cae7}a:visited{color:#4ce0d2;position:relative;top:2px}main{display:grid;grid-template-columns:minmax(0px, 1fr) minmax(320px, 1080px) minmax(0px, 1fr);padding:20px}main>*{grid-column:2}.site-header__header{grid-area:header;padding-bottom:4px}.site-header__title{color:#ffc914}.site-header__location{color:#fff;opacity:.5}.site-header__explainer{color:#fff}.data-picker{color:#fff;display:grid;grid-template-rows:auto 2rem;grid-template-columns:repeat(3, minmax(0, 160px)) auto;column-gap:16px;row-gap:8px;align-content:start}@media(max-width: 620px){.data-picker{grid-template-columns:repeat(3, minmax(0, 1fr))}}.data-picker__container{display:flex;flex-wrap:wrap;gap:4px}@media(max-width: 430px){.data-picker__container{font-size:.8rem}}@media(max-width: 375px){.data-picker__container{font-size:.7rem}}.data-picker__limits{opacity:.6}.data-picker__input{grid-row:2;accent-color:#84cae7;box-shadow:inset 3px 3px 10px 3px rgba(0,0,0,.2);text-align:right;font-size:1.5rem;border:none;border-bottom:4px solid #84cae7;border-radius:4px;padding-right:10px}@media(max-width: 430px){.data-picker__input{font-size:1rem}}.data-picker__button{height:100%;width:160px;grid-row:2;place-self:end start;display:flex;align-items:center;justify-content:center;gap:8px;background-color:#303134;border:2px solid #84cae7;border-radius:4px;color:#fff}.data-picker__button:hover{border:2px solid #4ce0d2}@media(max-width: 620px){.data-picker__button{width:100%;grid-row:3;grid-column:1/4}}.data-picker__button-text{padding-bottom:4px}.data-picker__icon{opacity:.8;position:relative;fill:#fff;height:24px}.data-picker__button:hover .data-picker__icon{opacity:1;fill:#4ce0d2}.data-picker__button:active .data-picker__icon{top:1px}.data-picker__disclaimer{grid-column:1/-1;place-self:end start;font-size:.8rem;opacity:.8}.chart{--tick-color: rgba(255, 255, 255, 0.2);--label-color: rgba(255, 255, 255, 0.8);width:100%;display:grid;grid:auto 1fr 20px auto/auto 1fr auto;padding-top:24px;grid-template-areas:". header header" "y-axis canvas summary" "origin x-axis summary" "credit credit credit"}@media(max-width: 600px){.chart{padding:24px 0px 0px 0px;grid-template-areas:". header" "y-axis canvas" "origin x-axis" "credit credit" "summary summary"}.chart .chart__credit{font-size:10px;padding-bottom:8px}}@media(max-width: 500px){.chart{grid-template-areas:"header header" "y-axis canvas" "origin x-axis" "credit credit" "summary summary"}.chart>div:first-of-type{padding-bottom:20px}}.chart__header{grid-area:header;padding-bottom:8px;font-size:clamp(10px, 2.5vw, 16px)}.chart__explainer{color:#fff}.chart__y-axis{grid-area:y-axis;display:grid;grid-template-columns:1fr clamp(6px, 1vw, 12px)}.chart__y-axis>p{position:relative;color:var(--label-color);grid-column:1;margin-right:4px;top:-12px;top:-7px;top:clamp(-12px, -2vw, -7px);text-align:right;font-size:clamp(10px, 3vw, 16px)}.chart__y-axis>div{grid-column:2;height:2px;width:100%;background:var(--tick-color)}.chart__y-axis div:nth-of-type(1){grid-row:1}.chart__y-axis div:nth-of-type(2){grid-row:2}.chart__y-axis div:nth-of-type(3){grid-row:3}.chart__y-axis div:nth-of-type(4){grid-row:4}.chart__grid{grid-area:canvas;display:grid;grid-template-columns:repeat(12, 1fr)}.chart__grid>div{width:100%;height:100%;border-right:2px solid rgba(255,255,255,.2)}.chart__canvas-container{grid-area:canvas;min-width:0px}.chart__origin{grid-area:origin;border-top:2px solid var(--tick-color);border-right:2px solid var(--tick-color);border-top-right-radius:4px;width:16px;height:100%;place-self:center end}.chart__x-axis{grid-area:x-axis;display:grid;grid-template-columns:repeat(12, 1fr)}.chart__x-axis>div{color:var(--label-color);text-align:center;width:100%;height:100%;border-right:2px solid var(--tick-color);margin:0}.chart__x-axis>div>p{margin:0;font-size:clamp(10px, 2vw, 16px)}.chart__summary{color:#fff;grid-area:summary;height:100%;padding-left:16px;display:grid;grid-template-rows:auto 1fr}@media(max-width: 600px){.chart__summary{padding-top:16px;padding-left:0}}.chart__summary-title{font-size:.8rem;font-weight:normal;opacity:.6;text-transform:uppercase;padding-bottom:4px}.chart__stats{display:grid;align-content:space-between;min-width:210px}@media(max-width: 600px){.chart__stats{grid-template-columns:1fr 1fr;column-gap:48px}}.chart__parameter-name{color:#ffc914}.chart__value{text-align:right}.chart__number{font-size:3rem;font-size:clamp(1.2rem, 3vw, 3rem)}.chart__separator{height:6px;background:linear-gradient(to right, transparent, #84cae7, #4ce0d2);width:80%;margin-left:auto}.chart__credit{grid-area:credit;place-self:start;color:#fff;font-size:12px;padding-top:8px}.controls{display:grid;grid-template-columns:repeat(2, minmax(250px, 1fr));place-content:center;place-items:center;column-gap:36px;row-gap:24px;padding:24px 0px}@media(max-width: 600px){.controls{grid-template-columns:1fr}}.controls__range{width:100%;accent-color:#84cae7;display:grid;grid-template-areas:"parameter value" "input input";row-gap:10px}.controls__parameter-name{grid-area:parameter;color:#fff;place-self:center start}.controls__input{grid-area:input;width:100%}.controls__value{grid-area:value;place-self:center end;padding-bottom:4px;color:#fff;text-align:right;padding-left:8px}.controls__number{font-size:2rem}.controls__unit{height:24px;grid-row:2;color:#fff}.description{color:#fff;padding:48px 0px}.description__title{padding-bottom:16px}.description__content{max-width:500px;line-height:1.5}.description__content>p:not(:last-child){padding-bottom:8px}.description__list{padding-bottom:8px}.description__equation-container{display:flex;flex-direction:column;gap:16px;border-left:2px solid #4ce0d2;margin:16px 0}.description__equation{padding-left:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-style:italic}.description__term{width:max-content}.description__composit{display:flex;flex-wrap:wrap}.description__unit{opacity:.8;width:max-content}.description__unit--fraction{display:flex;flex-direction:column;align-items:center;font-size:.8em}.description__unit--fraction p:first-child{border-bottom:1px solid #fff}.description__symbol{width:min-content}.description__github:link{color:#84cae7}.description__github:visited{color:#4ce0d2;position:relative;top:2px}.overlay{grid-area:canvas;place-self:center;color:#fff;z-index:1;border-bottom:2px solid #ffc914;width:80%}.overlay__title{font-size:clamp(1rem, 3vw, 2rem);text-align:center;padding-bottom:10px}.overlay__text{font-size:clamp(0.8rem, 2vw, 1.5rem)}</style>
        <title>Off-grid Calculator</title>
    </head>
    <body>
        <div id="state" class="state"></div>
        <main>
            <header class="site-header">
                <div class="site-header__header">
                    <h1 class="site-header__title">Off-grid Calculator</h1>
                </div>
            </header>
            <div class="data-picker">
                <div class="data-picker__container">
                    <label class="data-picker__label" for="data-picker__latitude">Latitude</label>
                    <p class="data-picker__limits">&#177;90</p>
                </div>
                <input class="data-picker__input" type="number" name="latitude" id="data-picker__latitude" min="-90" max="90" step="0.001" value="38.441" />
                <div class="data-picker__container">
                    <label class="data-picker__label" for="data-picker__longitude">Longitude</label>
                    <p class="data-picker__limits">&#177;180</p>
                </div>
                <input class="data-picker__input" type="number" name="longitude" id="data-picker__longitude" min="-180" max="180" step="0.001" value="-105.243" />
                <div class="data-picker__container">
                    <label class="data-picker__label" for="data-picker__angle">Panel Angle</label>
                    <p class="data-picker__limits">0-90</p>
                </div>
                <input class="data-picker__input" type="number" name="angle" id="data-picker__angle" min="0" max="90" step="1" value="62" />
                <button class="data-picker__button state__fetching" id="data-picker__button">
                    <p class="data-picker__button-text">Fetch Data</p>
                    <svg class="data-picker__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                    </svg>
                </button>
            </div>
            <div class="chart">
                <div class="chart__header state__calculator">
                    <p class="chart__explainer">Each dot indicates the energy storage level on that day (1/1-2005 to 12/31-2015)</p>
                </div>
                <div class="chart__y-axis state__calculator">
                    <p>100%</p>
                    <p>75%</p>
                    <p>50%</p>
                    <p>25%</p>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="chart__grid state__calculator">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <div class="chart__canvas-container state__calculator" id="chart__canvas-container">
                    <canvas id="canvas"></canvas>
                </div>
                <div class="chart__origin state__calculator"></div>
                <div class="chart__x-axis state__calculator">
                    <div>
                        <p>Jan</p>
                    </div>
                    <div>
                        <p>Feb</p>
                    </div>
                    <div>
                        <p>Mar</p>
                    </div>
                    <div>
                        <p>Apr</p>
                    </div>
                    <div>
                        <p>May</p>
                    </div>
                    <div>
                        <p>Jun</p>
                    </div>
                    <div>
                        <p>Jul</p>
                    </div>
                    <div>
                        <p>Aug</p>
                    </div>
                    <div>
                        <p>Sep</p>
                    </div>
                    <div>
                        <p>Oct</p>
                    </div>
                    <div>
                        <p>Nov</p>
                    </div>
                    <div>
                        <p>Dec</p>
                    </div>
                </div>
                <div class="chart__summary state__calculator">
                    <h2 class="chart__summary-title">Annual average</h2>
                    <div class="chart__stats">
                        <div class="chart__stat">
                            <p class="chart__parameter-name">Energy Deficit</p>
                            <p class="chart__value"><span class="chart__number" id="chart__deficit"></span> kWh</p>
                            <div class="chart__separator"></div>
                        </div>
                        <div class="chart__stat">
                            <p class="chart__parameter-name">Empty Storage</p>
                            <p class="chart__value"><span class="chart__number" id="chart__empty"></span> days</p>
                            <div class="chart__separator"></div>
                        </div>
                        <div class="chart__stat">
                            <p class="chart__parameter-name">Energy Surplus</p>
                            <p class="chart__value"><span class="chart__number" id="chart__surplus"></span> kWh</p>
                            <div class="chart__separator"></div>
                        </div>
                        <div class="chart__stat">
                            <p class="chart__parameter-name">Full Storage</p>
                            <p class="chart__value"><span class="chart__number" id="chart__full"></span> days</p>
                            <div class="chart__separator"></div>
                        </div>
                    </div>
                </div>
                <div class="chart__credit state__calculator">
                    <p>Based on solar radiation acquired via <a href="https://ec.europa.eu/jrc/en/pvgis">PVGIS</a>. See below remarks for further details</p>
                </div>
                <div class="overlay state__overlay">
                    <h2 class="overlay__title" id="overlay__title">Pick a location to get started</h2>
                    <p class="overlay__text" id="overlay__text"></p>
                </div>
            </div>
            <div class="controls state__calculator">
                <div class="controls__range">
                    <label class="controls__parameter-name" for="solar">Collector Area</label>
                    <p class="controls__value"><span class="controls__number" id="controls__solar"></span> m<sup>2</sup></p>
                    <input class="controls__input" id="solar" type="range" />
                </div>
                <div class="controls__range">
                    <label class="controls__parameter-name" for="efficiency">Collector Efficiency</label>
                    <p class="controls__value"><span class="controls__number" id="controls__efficiency"></span> %</p>
                    <input class="controls__input" id="efficiency" type="range" />
                </div>
                <div class="controls__range">
                    <label class="controls__parameter-name" for="htc">Whole House Heat Transfer Coefficient</label>
                    <p class="controls__value"><span class="controls__number" id="controls__htc"></span> <sup>W</sup>/<sub>&deg;C</sub></p>
                    <input class="controls__input" id="htc" type="range">
                </div>
                <div class="controls__range">
                    <label class="controls__parameter-name" for="storage">Storage Capacity</label>
                    <p class="controls__value"><span class="controls__number" id="controls__storage"></span> kWh</p>
                    <input class="controls__input" id="storage" type="range" />
                </div>
            </div>
            <div class="description">
                <h2 class="description__title">The math behind it all</h2>
                <div class="description__content">
                    <p>The simulation is built on an extremely simple model with only a handful of inputs.</p>
                    <p>It is based on solar radiation data acquired via <a href="https://ec.europa.eu/jrc/en/pvgis">PVGIS</a> and fetched through a Cloudflare Worker. See the <a href="https://ec.europa.eu/jrc/en/PVGIS/docs/usermanual">PVGIS users manual</a> for details on the used databases. PVGIS gets data on the Americas from <a href="https://nsrdb.nrel.gov/">NSRDB</a> as collected by <a href="https://www.nrel.gov/">NREL</a></p>
                    <p>Each retrieved dataset consists of 96,408 datapoints covering the hours between 1/1-2005 and 12/31-2015. After retrieval, the data is remapped into 24 hour intervals. Each datapoint has two values for that 24 hour period:</p>
                    <ul class="description__list">
                        <li>The total solar insolation (based on global irradiance) at the chosen angle at the chosen location</li>
                        <li>The average outdoor temperature at a height of 2 meters</li>
                    </ul>
                    <p>The two values are used to calculate the energy-gain and energy-loss for that day.</p>
                </div>
                <div class="description__equation-container">
                    <div class="description__equation">
                        <p class="description__term">Energy<sub>gain</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                        <p class="description__symbol">=</p>
                        <p class="description__term">Collector&#8209;area</p>
                        <div class="description__unit">
                            <p>m<sup>2</sup></p>
                        </div>
                        <p class="description__symbol">&#215;</p>
                        <p class="description__term">Total&#8209;solar&#8209;insolation</p>
                        <div class="description__unit description__unit--fraction">
                            <p>Wh</p>
                            <p>m<sup>2</sup></p>
                        </div>
                        <p class="description__symbol">&#215;</p>
                        <p class="description__term">Collector&#8209;efficiency</p>
                    </div>
                    <div class="description__equation">
                        <p class="description__term">Energy<sub>loss</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                        <p class="description__symbol">=</p>
                        <p class="description__term">Whole&#8209;house&#8209;heat&#8209;transfer&#8209;coefficient</p>
                        <div class="description__unit description__unit--fraction">
                            <p>W</p>
                            <p>&deg;C</p>
                        </div>
                        <p class="description__symbol">&#215;</p>
                        <div class="description__composit">
                            <p class="description__symbol">(&nbsp;</p>
                            <p class="description__term">Average&#8209;outdoor&#8209;temperature</p>
                            <p class="description__symbol">&nbsp;&#8722;&nbsp;</p>
                            <p class="description__term">Indoor&#8209;temperature</p>
                            <p class="description__symbol">&nbsp;)</p>
                        </div>
                        <div class="description__unit"><p>&deg;C</p></div>
                        <p class="description__symbol">&#215;</p>
                        <p class="description__term">24</p>
                        <div class="description__unit description__unit--fraction">
                            <p>s Wh</p>
                            <p>J</p>
                        </div>
                    </div>
                </div>
                <div class="description__content">
                    <p>The indoor temperature is set at 22 &deg;C</p>
                    <p>At the simulation outset, the energy-storage is full. The net-gain (or loss) for each day is then added to the storage, either increasing or decreasing its level. The storage level is not allowed to exceed the chosen maximum or fall below 0 kWh</p>
                </div>
                <div class="description__equation-container">
                    <div class="description__equation">
                        <p class="description__term">Storage<sub>tomorrow</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                        <p class="description__symbol">=</p>
                        <p class="description__term">Energy<sub>gain</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                        <p class="description__symbol">+</p>
                        <p class="description__term">Energy<sub>loss</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                        <p class="description__symbol">+</p>
                        <p class="description__term">Storage<sub>today</sub></p>
                        <div class="description__unit"><p>Wh</p></div>
                    </div>
                </div>
                <div class="description__content">
                    <p>Due to the model's simplicity there's naturally a long list of factors which it does not account for.</p>
                    <p>To name just a few:</p>
                    <ul class="description__list">
                        <li>Energy losses from the storage tank or battery</li>
                        <li>Conversion losses between collector and tank or battery</li>
                        <li>Solar heat gain through windows</li>
                        <li>Internal gains not powered by the collectors</li>
                    </ul>
                    <p>As the model is based on historical solar and weather data without any additional statistical treatment it cannot make any predicitions on future conditions</p>
                    <a class="description__github" href="https://github.com/DLFDK/Offgrid-calculator">Github</a>
                </div>
            </div>
        </main>
        <script>async function main(){const t={root:document.documentElement,title:document.getElementById("overlay__title"),text:document.getElementById("overlay__text"),loadedText:"Success!",unloadedText:"Pick a location to get started",fetchingText:"Fetching, please wait...",errorText:errorText="Oops! Looks like there was an error fetching the data",state:"unloaded",set(t,e){switch(this.state=t,t){case"fetching":this.title.textContent=this.fetchingText,this.text.textContent="",this.root.style.setProperty("--state__fetching--opacity",.5),this.root.style.setProperty("--state__calculator--opacity",.5),this.root.style.setProperty("--state__overlay--opacity",1);break;case"loaded":this.title.textContent=this.loadedText,this.text.textContent="",this.root.style.setProperty("--state__fetching--opacity",1),this.root.style.setProperty("--state__calculator--opacity",1),this.root.style.setProperty("--state__overlay--opacity",0);break;case"error":this.title.textContent=this.errorText,this.text.textContent=e,this.root.style.setProperty("--state__fetching--opacity",1),this.root.style.setProperty("--state__calculator--opacity",.5),this.root.style.setProperty("--state__overlay--opacity",1)}}},e={deficit:document.getElementById("chart__deficit"),empty:document.getElementById("chart__empty"),surplus:document.getElementById("chart__surplus"),full:document.getElementById("chart__full")},o={button:document.getElementById("data-picker__button"),latitude:document.getElementById("data-picker__latitude"),longitude:document.getElementById("data-picker__longitude"),angle:document.getElementById("data-picker__angle")},a={numOfYears:{value:11},indoorT:{value:22},solar:{min:10,max:50,value:30,step:1},efficiency:{min:10,max:100,value:60,step:1},htc:{min:10,max:300,value:250,step:5},storage:{min:10,max:1e3,value:200,step:10}};for(const e of document.getElementsByClassName("controls__input"))e.min=a[e.id].min,e.max=a[e.id].max,e.step=a[e.id].step,e.value=a[e.id].value,document.getElementById("controls__"+e.id).textContent=a[e.id].value,e.addEventListener("input",(o=>{document.getElementById("controls__"+e.id).textContent=o.target.value,a[e.id].value=o.target.value,"loaded"===t.state&&u()}));const n=document.getElementById("chart__canvas-container"),s=document.getElementById("canvas"),l=s.getContext("2d"),r=window.devicePixelRatio;s.style.height=n.offsetHeight+"px",s.style.width=n.offsetWidth+"px",s.width=Math.floor(n.offsetWidth*r),s.height=Math.floor(n.offsetHeight*r),l.scale(r,r);const i=n.offsetHeight-2,c=(n.offsetWidth-2)/365;t.set("fetching");let d=await fetch("js/data.json").then((t=>t.json()));function u(){l.clearRect(0,0,s.width,s.height),l.fillStyle="#4CE0D2";const t=[],o=1e3*a.storage.value;t.push(o);const n=i/a.storage.value;let r=0,u=0,h=0,m=0;for(let e=0;e<d.Energy.length;e++){const s=a.solar.value*d.Energy[e]*(a.efficiency.value/100)+Math.min(a.htc.value*(d.Temperature[e]-a.indoorT.value)*24,0)+t[e];s>o?(t.push(o),m++,h+=s-o):s<0?(t.push(0),u++,r+=s):t.push(s);const y=e%365*c,f=i-t[e+1]/1e3*n;l.fillRect(y,f,2,2)}e.surplus.textContent=Math.round(h/a.numOfYears.value/1e3),e.deficit.textContent=Math.round(r/a.numOfYears.value/-1e3),e.full.textContent=Math.round(m/a.numOfYears.value),e.empty.textContent=Math.round(u/a.numOfYears.value)}u(),t.set("loaded"),o.button.addEventListener("click",(async()=>{t.set("fetching");const e=`https://off-grid.dlfdk.workers.dev/api/seriescalc?lat=${o.latitude.value}&lon=${o.longitude.value}&browser=1&outputformat=json&usehorizon=1&angle=${o.angle.value}&startyear=2005&endyear=2015`,a=await fetch(e).then((t=>t.json()));a.message?t.set("error",a.message):(d=function(t){const{inputs:{meteo_data:{radiation_db:e}},outputs:{hourly:o}}=t,a=Math.round(o.length/24),n={Energy:[],Temperature:[]};for(let t=0;t<a;t++){let e=0,a=0;for(let n=24*t;n<24*(t+1);n++)e+=o[n]["G(i)"],a+=o[n].T2m;n.Energy.push(Math.round(e)),n.Temperature.push(a/24)}return n}(a),u(),t.set("loaded"))}))}main();</script>
    </body>
</html>
